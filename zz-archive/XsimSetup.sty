\ProvidesPackage{XsimSetup}

\RequirePackage{xsim}

\DeclareExerciseTagging{difficulty}
\DeclareExerciseTagging{usage} %probably obsolete
\DeclareExerciseTagging{mc} %probably obsolete
\DeclareExerciseProperty{source}

\loadxsimstyle{layouts}

% Fakesection mymargin
\DeclareExerciseEnvironmentTemplate{mymargin}
{%
  \trivlist
  \item[\llap{%
      \smash{%
        \tabular[t]{@{}r@{}}
        \textbf{\GetExerciseName\GetExerciseProperty{counter}.}
        \endtabular
      }%
    }]\relax
}
{\endtrivlist}

\DeclareExerciseEnvironmentTemplate{mynewmargin}
{% 
  \trivlist 
\item[\llap{% 
    \smash{% 
      \tabular[t]{@{}r@{}} 
      \textbf{\XSIMmixedcase{\GetExerciseName}\GetExerciseProperty{counter}}.
      \IfExercisePropertySetT{points}{% 
        \tabularnewline% 
        \fbox{\ttfamily\small\bfseries\printgoal{\GetExerciseProperty{points}}% 
        \GetExercisePropertyT{bonus-points}{+\printgoal{#1}}% 
      \,\XSIMtranslate{point-abbr}}% 
      }% 
      \endtabular 
    }% 
  }]\relax 
} 
{\endtrivlist}

% Fakesection mymargindetails
\DeclareExerciseEnvironmentTemplate{mymargindetails}
{%
  \trivlist
\item[\llap{%
    \smash{%
      \tabular[t]{@{}r@{}}
      \textbf{\GetExerciseName\GetExerciseProperty{counter}.}
      \endtabular
    }%
  }]\relax
  \GetExercisePropertyT{subtitle}{ \textit{(#1)}} % <<< notice the space
  {%
    \IfInsideSolutionF
    {%
      \GetExercisePropertyT{topics}
      { {\ttfamily\bfseries\textcolor{Black!60}{\PropertyValue}\nobreakspace}}%
      \GetExercisePropertyT{source}
      { \hfill{\ttfamily\textcolor{Black!60}{\PropertyValue}}\nobreakspace}%
      \GetExercisePropertyT{difficulty}
      { {\ttfamily\textcolor{Red}{\PropertyValue}}}%
      \newline
      \GetExercisePropertyT{tags}
      { {\ttfamily\textcolor{Black!60}{\PropertyValue}}}%
      \GetExercisePropertyT{ID}
      { \hfill{\ttfamily\textcolor{Gray}{\PropertyValue}}\par}%
    }%
  }
}
{\endtrivlist}

% Fakesection mysolutionrunin
\DeclareExerciseEnvironmentTemplate{mysolutionrunin}
{%
  \par\vspace{\baselineskip}
  \Needspace*{2\baselineskip}
  \noindent
  %\textbf{\XSIMmixedcase{\GetExerciseName}~\GetExerciseProperty{counter}}%
  \begin{tcolorbox}[%
    parbox=false,
    enhanced,
    breakable,
    oversize,
    left=15pt,
    right=15pt,
    top=9pt,
    boxrule=0.1mm,
    arc=0mm,
    outer arc=0mm,
    colframe=ForestGreen!50,
    colback=ForestGreen!3,
    colbacktitle=ForestGreen,
    coltitle=White,
    title={\ttfamily\bfseries\small \GetExerciseName},
    attach boxed title to top left={xshift=5pt,yshift=-\tcboxedtitleheight/2},
    boxed title style={size=small,boxrule=0pt,arc=0pt,colback=ForestGreen!30, outer arc=0mm,top=0pt,left=0pt,right=0pt,bottom=0pt}
    ]
    %\textbf{\textcolor{ForestGreen}{\XSIMmixedcase{\GetExerciseName}:}}%
    %\GetExercisePropertyT{subtitle}{ \textit{#1}} % <<< notice the space
    \IfInsideSolutionF{%
      \GetExercisePropertyT{points}{%
        \marginpar{%
          \printgoal{\PropertyValue}%
          \GetExercisePropertyT{bonus-points}{+\printgoal{\PropertyValue}}%
          \,\IfExerciseGoalSingularTF{points}
          {\XSIMtranslate{point}}
          {\XSIMtranslate{points}}%
        }%
      }%
    }%
  }
{\end{tcolorbox}}


% Fakesection Point Translations (probably unnecessary)
\DeclareExerciseTranslations{points}{
  Fallback = points ,
  English = points ,
}
\DeclareExerciseTranslations{point}{
  Fallback = point ,
  English = point ,
}
\DeclareExerciseTranslations{point-abbr}{
  Fallback = pts ,
  English = pt. ,
}

% Fakesection Exercise Types
\DeclareExerciseType{multiplechoice}{
  exercise-env = multiplechoice ,
  solution-env = mcsolution ,
  exercise-name = MC,
  solution-name = solution ,
  solutions-name = solutions ,
  exercise-template = mymargin ,
  solution-template = mysolutionrunin ,
  exercise-heading = \subsection* ,
  solution-heading = \subsection*
}

\DeclareExerciseType{question}{
  exercise-env = question ,
  solution-env = qsolution ,
  exercise-name = Q,
  solution-name = solution ,
  solutions-name = \XSIMtranslate{solutions} ,
  exercise-template = mynewmargin ,
  solution-template = mysolutionrunin ,
  exercise-heading = \subsection* ,
  solution-heading = \subsection*
}

\DeclareExerciseType{subquestion}{
  exercise-env = subquestion ,
  solution-env = subqsolution ,
  exercise-name = Q,
  solution-name = solution ,
  solutions-name = solutions ,
  exercise-template = mynewmargin ,
  solution-template = mysolutionrunin ,
  exercise-heading = \subsection* ,
  the-counter=\thequestion\alph{subquestion},
  solution-heading = \subsection*
}

% Fakesection Setups
\ifdefined\Solutions
  \xsimsetup{%
    qsolution/print = true,
    subqsolution/print = true,
    mcsolution/print = true
  }
\fi

\ifdefined\MyComments
  \xsimsetup{%
    multiplechoice/template = mymargindetails ,
    question/template = mymargindetails ,
    subquestion/template = mymargindetails
  }
\fi

%Not an xsim setting, but appropriate to declare here:
\counterwithin{equation}{question}
